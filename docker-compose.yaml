version: '3.8'

services:
  # https://docs.traefik.io
  # https://www.smarthomebeginner.com/my-smart-home-setup-2019/
  traefik:
    # The official v2 Traefik docker image
    image: "traefik:chevrotin"
    container_name: "traefik"
    restart: always
    environment:
      # https://docs.traefik.io/https/acme/#providers
      - CF_DNS_API_TOKEN=${CLOUDFLARE_API_KEY}
      - TZ=$TZ
      - PUID=$PUID
      - PGID=$PGID
    command:
    #### These are the CLI commands that will configure Traefik and tell it how to work! ####
      ## API Settings - https://docs.traefik.io/operations/api/, endpoints - https://docs.traefik.io/operations/api/#endpoints ##
      - "--api.dashboard=true" # <== Enabling the dashboard to view services, middlewares, routers, etc...
      ## Log Settings (options: ERROR, DEBUG, PANIC, FATAL, WARN, INFO) - https://docs.traefik.io/observability/logs/ ##
      #- "--log.level=DEBUG"
      - "--log.level=INFO"
      ## Provider Settings - https://docs.traefik.io/providers/docker/#provider-configuration ##
      - "--providers.docker=true" # <== Enabling docker as the provider for traefik
      - "--providers.docker.exposedbydefault=false" # <== Don't expose every container to traefik, only expose enabled ones
      - "--providers.docker.network=t2_proxy"
      - "--providers.file=true" # Enable file provider for services hosted outside of docker compose.
      - "--providers.file.watch=true"
      - "--providers.file.filename=/etc/traefik/dynamic.yaml" # <== Referring to a dynamic configuration file
      ## Entrypoints Settings - https://docs.traefik.io/routing/entrypoints/#configuration ##
      # https://docs.traefik.io/migration/v1-to-v2/#http-to-https-redirection-is-now-configured-on-routers
      - "--entrypoints.web.address=:80"  # HTTP
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"    # HTTPS
      # Allow these IPs to set the X-Forwarded-* headers - Cloudflare IPs: https://www.cloudflare.com/ips/
      - --entrypoints.websecure.forwardedHeaders.trustedIPs=173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/12,172.64.0.0/13,131.0.72.0/22
      ## Certificate Settings (DNS Challenge w/ Cloudflare) -  https://docs.traefik.io/https/acme/#configuration-examples ##
      - "--certificatesresolvers.dns-cloudflare.acme.email=$EMAIL"
      - "--certificatesresolvers.dns-cloudflare.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.dns-cloudflare.acme.dnschallenge=true"
      # Commented out because: https://www.smarthomebeginner.com/traefik-2-docker-tutorial/#Forcing_the_Use_of_Wildcard_Certs
      # - "--certificatesresolvers.dns-cloudflare.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.dns-cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53, 1.0.0.1:53"
      ## Global settings
      - "--global.sendAnonymousUsage" # <== Send anonymous usage data https://docs.traefik.io/contributing/data-collection/
      
     # networks:
     #   t2_proxy:
     #    ipv4_address: 192.168.90.254 # You can specify a static IP
    networks:
      - t2_proxy
    security_opt:
      - no-new-privileges:true
    ports:
      - "8080:80"  # <== http
      - "8443:443"  # <== https
    volumes:
      - "./traefik:/etc/traefik:ro" # <== Traefik looks for config at /etc/traefik/traefik.yaml https://docs.traefik.io/getting-started/configuration-overview/#configuration-file
      - "letsencrypt:/letsencrypt" # <== Volume for certs (TLS)
      # TODO Docker Socket
      - "/var/run/docker.sock:/var/run/docker.sock:ro" # <== So that Traefik can listen to the Docker events.
    labels:
    #### Labels define the behavior and rules of the traefik proxy for this container. ####     
      - "traefik.enable=true" # <== Enable traefik on itself to view dashboard and assign subdomain to view it
      - "traefik.http.routers.traefik-secure.rule=Host(`traefik.${DOMAINNAME}`)"
      - "traefik.http.routers.traefik-secure.service=api@internal"
      - "traefik.http.routers.traefik-secure.entryPoints=websecure"
      - "traefik.http.routers.traefik-secure.tls=true"
      - "traefik.http.routers.traefik-secure.tls.certResolver=dns-cloudflare"
      - "traefik.http.routers.traefik-secure.middlewares=chain-oauth@file"
      
      #- "traefik.http.routers.traefik-secure.middlewares=traefik-auth"
      #- "traefik.http.middlewares.traefik-auth.basicauth.usersfile=/shared/.htpasswd"

  # Google OAuth - Single Sign On using OAuth 2.0
  # https://www.smarthomebeginner.com/traefik-2-docker-tutorial/#Setting_Up_OAuth_Forwarder_Container
  # https://www.smarthomebeginner.com/google-oauth-with-traefik-docker/#Step_3a_Add_Traefik_OAuth_Container
  oauth:
    image: thomseddon/traefik-forward-auth:latest
    container_name: oauth
    restart: always
    networks:
      - t2_proxy
    security_opt:
      - no-new-privileges:true
    environment:
      - TZ=$TZ
      - PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID}
      - PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET}
      - SECRET=${OAUTH_SECRET}
      - COOKIE_DOMAIN=${DOMAINNAME}
      - INSECURE_COOKIE="false"
      - AUTH_HOST=oauth.${DOMAINNAME}
      - URL_PATH=/_oauth
      - WHITELIST=$EMAILS
      - LOG_LEVEL=info
      - LOG_FORMAT=text
      - LIFETIME=2592000 # 30 days
    labels:
      - "traefik.enable=true" 
     ## HTTP Routers
      - "traefik.http.routers.oauth-secure.entrypoints=websecure"
      - "traefik.http.routers.oauth-secure.rule=Host(`oauth.${DOMAINNAME}`)"
      - "traefik.http.routers.oauth-secure.tls=true"
      ## HTTP Services
      - "traefik.http.routers.oauth-secure.service=oauth-svc"
      - "traefik.http.services.oauth-svc.loadbalancer.server.port=4181"
      ## Middlewares
      - "traefik.http.routers.oauth-secure.middlewares=chain-oauth@file"


  # https://github.com/oznu/docker-cloudflare-ddns
  cloudflare-ddns:
    image: oznu/cloudflare-ddns
    container_name: "cloudflare-ddns"
    restart: always
    environment:
      - TZ=$TZ
      - API_KEY=${CLOUDFLARE_API_KEY}
      - ZONE=${DOMAINNAME}
      - PROXIED=true

  # https://www.smarthomebeginner.com/traefik-docker-security-best-practices/#9_Use_a_Docker_Socket_Proxy  
  # Docker Socket Proxy - Security Enchanced Proxy for Docker Socket
  socket-proxy:
    container_name: socket-proxy
    image: tecnativa/docker-socket-proxy
    restart: always
    networks:
      # t2_proxy:
      socket_proxy:
        ipv4_address: 192.168.91.254 # You can specify a static IP
    privileged: true
    # ports:
    #  - "2375:2375"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    environment:
      - LOG_LEVEL=info # debug,info,notice,warning,err,crit,alert,emerg
      ## Variables match the URL prefix (i.e. AUTH blocks access to /auth/* parts of the API, etc.).
      # 0 to revoke access.
      # 1 to grant access.
      ## Granted by Default
      - EVENTS=1
      - PING=1
      - VERSION=1
      ## Revoked by Default
      # Security critical
      - AUTH=0
      - SECRETS=0
      - POST=1 # Ouroboros
      # Not always needed
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - CONTAINERS=1 # Traefik, portainer, etc.
      - DISTRIBUTION=0
      - EXEC=0
      - IMAGES=1 # Portainer
      - INFO=1 # Portainer
      - NETWORKS=1 # Portainer
      - NODES=0
      - PLUGINS=0
      - SERVICES=1 # Portainer
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=1 # Portaienr
      - VOLUMES=1 # Portainer
  
  # https://github.com/htpcBeginner/docker-traefik/blob/e5e1ad70e3a9f6e6fcb5c1d65ea03a55c1f84599/docker-compose-t2.yml
  # Ouroboros - Automatic Docker Container Updates
  ouroboros:
    image: pyouroboros/ouroboros:latest
    container_name: ouroboros
    restart: unless-stopped
    networks:
      - default
      - socket_proxy
    # depends_on:
    #  - socket-proxy
    volumes:
      # - /var/run/docker.sock:/var/run/docker.sock # Use Docker Socket Proxy instead for improved security
      - $DOCKERDIR/ouroboros/config.json:/root/.docker/config.json:ro
    environment:
      TZ: $TZ
      INTERVAL: 86400
      LOG_LEVEL: info
      SELF_UPDATE: "true"
      CLEANUP: "true"
      #IGNORE: traefik influxdb addon_core_check_config addon_62c7908d_autobackup plexms
      #NOTIFIERS: "tgram://$TGRAM_BOT_TOKEN/$TGRAM_CHAT_ID/"
      DOCKER_SOCKETS: tcp://socket-proxy:2375 # POST to be enabled on Socket Proxy
      
  # Portainer - WebUI for Containers
  # https://www.smarthomebeginner.com/traefik-2-docker-tutorial/#Portainer_with_Traefik_2_and_OAuth
  portainer:
    container_name: portainer
    image: portainer/portainer:latest
    restart: always
    # TODO Docker Socket
    command: -H unix:///var/run/docker.sock
    networks:
      - t2_proxy
    security_opt:
      - no-new-privileges:true
     # ports:
     # - "$PORTAINER_PORT:9000"
    volumes:
      # TODO Docker Socket
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - $DOCKERDIR/portainer/data:/data 
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    labels:
      - "traefik.enable=true"
      ## HTTP Routers
      - "traefik.http.routers.portainer-secure.entrypoints=websecure"
      - "traefik.http.routers.portainer-secure.rule=Host(`portainer.${DOMAINNAME}`)"
      - "traefik.http.routers.portainer-secure.tls=true"
      ## Middlewares
      # - "traefik.http.routers.portainer-rtr.middlewares=chain-no-auth@file" # No Authentication
      # - "traefik.http.routers.portainer-rtr.middlewares=chain-basic-auth@file" # Basic Authentication
      - "traefik.http.routers.portainer-secure.middlewares=chain-oauth@file" # Google OAuth 2.0
      ## HTTP Services
      - "traefik.http.routers.portainer-secure.service=portainer-svc"
      - "traefik.http.services.portainer-svc.loadbalancer.server.port=9000"
      
  # Organizr - Unified frontent with a directory for all ports and services
  # https://www.smarthomebeginner.com/traefik-2-docker-tutorial/#Organizr_-_Unified_HTPCHome_Server_Web_Interface
  organizr:
     container_name: organizr
     image: organizrtools/organizr-v2:latest
     restart: always
     networks:
       - t2_proxy
     security_opt:
       - no-new-privileges:true
    # ports:
    #  - "$ORGANIZR_PORT:80"
     volumes:
       - $DOCKERDIR/organizr:/config
     environment:
       - PUID=$PUID
       - PGID=$PGID
       - TZ=$TZ
     labels:
       - "traefik.enable=true"
       ## HTTP Routers
       - "traefik.http.routers.organizr-secure.entrypoints=websecure"
       - "traefik.http.routers.organizr-secure.rule=Host(`${DOMAINNAME}`,`www.${DOMAINNAME}`)" 
       - "traefik.http.routers.organizr-secure.tls=true"
       ## Middlewares
       - "traefik.http.routers.organizr-rtr.middlewares=chain-oauth@file" 
       ## HTTP Services
       - "traefik.http.routers.organizr-secure.service=organizr-svc"
       - "traefik.http.services.organizr-svc.loadbalancer.server.port=80"
      
  # MariaDB - MySQL Database
  # https://www.smarthomebeginner.com/traefik-2-docker-tutorial/#MariaDB_-_MySQL_Database
  mariadb:
     container_name: mariadb
     image: linuxserver/mariadb:latest
     restart: always
     networks:
       t2_proxy:
         ipv4_address: 192.168.90.250 
     security_opt:
       - no-new-privileges:true
     ports:
       - "3306:3306"
     volumes:
       - $DOCKERDIR/mariadb/data:/config
       # TODO
      # - /etc/timezone:/etc/timezone:ro
       - /etc/localtime:/etc/localtime:ro
     environment:
       - PUID=$PUID
       - PGID=$PGID
       - MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD

  # Guacamole - Remote desktop, SSH, on Telnet on any HTML5 Browser 
  # https://www.smarthomebeginner.com/traefik-2-docker-tutorial/#Guacamole_-_HTML_5_based_Remote_desktop_SSH_on_Telnet_Gateway
  # TODO DB setup
  guacamole:
    image: guacamole/guacamole:latest
    container_name: guacamole
    restart: always
    networks:
      - t2_proxy
    security_opt:
      - no-new-privileges:true
    #ports:
    #  - "$GUACAMOLE_PORT:8080"
    environment:
      GUACD_HOSTNAME: guacd
      MYSQL_HOSTNAME: 192.168.90.250 
      MYSQL_PORT: 3306
      MYSQL_DATABASE: guacamole
      MYSQL_USER: $GUAC_MYSQL_USER
      MYSQL_PASSWORD: $GUAC_MYSQL_PASSWORD #TODO
    labels:
      - "traefik.enable=true"
      ## HTTP Routers
      - "traefik.http.routers.guacamole-secure.entrypoints=websecure"
      - "traefik.http.routers.guacamole-secure.rule=Host(`guac.${DOMAINNAME}`)"
      - "traefik.http.routers.guacamole-secure.tls=true"
      ## Middlewares
      - "traefik.http.routers.guacamole-secure.middlewares=chain-oauth@file,add-guacamole" 
      - "traefik.http.middlewares.add-guacamole.addPrefix.prefix=/guacamole"
      ## HTTP Services
      - "traefik.http.routers.guacamole-secure.service=guacamole-svc"
      - "traefik.http.services.guacamole-svc.loadbalancer.server.port=8080"

  # Guacamole Daemon - Needed for Guacamole
  guacd:
    image: guacamole/guacd
    container_name: guacd
    restart: always
    security_opt:
      - no-new-privileges:true

  # https://github.com/plexinc/pms-docker/blob/master/docker-compose-bridge.yml.template
  plex:
    image: plexinc/pms-docker:public
    container_name: plex
    restart: always
    networks:
      - t2_proxy
    security_opt:
      - no-new-privileges:true
    ports: # https://support.plex.tv/articles/201543147-what-network-ports-do-i-need-to-allow-through-my-firewall/
     - 32400:32400/tcp # Primary
     #- 3005:3005/tcp # Plex Home Theater Companion
     #- 8324:8324/tcp # Plex Roku Companion
     - 32469:32469/tcp # Plex DLNA Server
     - 1900:1900/udp # Plex DLNA Server
     - 32410:32410/udp # GDM network discovery
     - 32412:32412/udp # GDM network discovery
     - 32413:32413/udp # GDM network discovery
     - 32414:32414/udp # GDM network discovery
    environment:
      - TZ=$TZ
      - PLEX_CLAIM=${PLEX_CLAIM_TOKEN}
      - ADVERTISE_IP=http://192.168.1.254:32400/,https://plex.${DOMAINNAME}
    hostname: "PlexServer"
    volumes:
      - $DOCKERDIR/plex_config:/config
      - /mnt/user/appdata/tmp/plex_tmp:/transcode
      - /mnt/user/media:/data
    labels:
      - "traefik.enable=true" 
      ## Routers
      - "traefik.http.routers.plex-secure.rule=Host(`plex.${DOMAINNAME}`)"
      - "traefik.http.routers.plex-secure.entryPoints=websecure"
      - "traefik.http.routers.plex-secure.tls=true"
      ## Middlewares
      - "traefik.http.routers.plex-secure.middlewares=chain-no-auth@file"
      ## Services
      - "traefik.http.routers.plex-secure.service=plexms-svc"
      - "traefik.http.services.plexms-svc.loadbalancer.server.port=32400"

  # https://github.com/shawly/docker-ps3netsrv
  ps3netsrv:
    image: shawly/ps3netsrv
    container_name: ps3netsrv
    environment:
      - TZ=$TZ
      - USER_ID=$PUID
      - GROUP_ID=$PGID
    ports:
      - "38008:38008"
    volumes:
      - "/mnt/user/games/PS3Games:/games:rw"
   
  # Run all Transmission traffic through VPN Unlimited
  # https://github.com/haugene/docker-transmission-openvpn   
  # https://www.smarthomebeginner.com/docker-home-media-server-2018-basic/#Transmission_with_VPN_-_Bittorrent_Downloader
  transmission-vpn:
    image: haugene/transmission-openvpn
    container_name: transmission-vpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    restart: always
    ports:
    - "9091:9091"
    dns:
      - 1.1.1.1
      - 1.0.0.1
    volumes:
      - /etc/localtime:/etc/localtime:ro
      # OpenVPN config generated with https://www.vpnunlimitedapp.com/help/manuals/how-to-manually-create-vpn-conf
      #- $DOCKERDIR/transmission-vpn/vpnunlimited-openvpn:/etc/openvpn/vpnunlimited:ro
      - /mnt/user/downloads/transmission:/data
      - /mnt/user/downloads/transmission/completed:/data/completed
      - /mnt/user/downloads/transmission/incomplete:/data/incomplete
    environment:
      - OPENVPN_PROVIDER=VPNUNLIMITED
      - OPENVPN_USERNAME=$VPN_UNLIMITED_USERNAME
      - OPENVPN_PASSWORD=$VPN_UNLIMITED_PASSWORD
      - OPENVPN_CONFIG=us-sf,ca-tr  # Corresponds to a file name in https://github.com/haugene/docker-transmission-openvpn/tree/master/openvpn/vpnunlimited or $DOCKERDIR/transmission-vpn/vpnunlimited-openvpn
      - OPENVPN_OPTS=--inactive 3600 --ping 10 --ping-exit 60
      - LOCAL_NETWORK=192.168.1.0/24
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - TRANSMISSION_RPC_AUTHENTICATION_REQUIRED=true
      - TRANSMISSION_RPC_HOST_WHITELIST=127.0.0.1,192.168.1.*
      - TRANSMISSION_RPC_PASSWORD=$TRANSMISSION_WEBUI_PASSWORD
      - TRANSMISSION_RPC_USERNAME=$TRANSMISSION_WEBUI_USERNAME
      - TRANSMISSION_UMASK=022
      - TRANSMISSION_SPEED_LIMIT_UP=225 #KB/s
      - TRANSMISSION_SPEED_LIMIT_UP_ENABLED=true
      #- TRANSMISSION_RATIO_LIMIT=2.00
      #- TRANSMISSION_RATIO_LIMIT_ENABLED=false

  # https://prometheus.io/docs/guides/cadvisor/#docker-compose-configuration
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: always
    #ports:
    # - 9090:9090
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    volumes:
      - $DOCKERDIR/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - cadvisor
    networks:
      - t2_proxy
    labels:
      - "traefik.enable=true" 
      ## Routers
      - "traefik.http.routers.prometheus-secure.rule=Host(`prometheus.${DOMAINNAME}`)"
      - "traefik.http.routers.prometheus-secure.entryPoints=websecure"
      - "traefik.http.routers.prometheus-secure.tls=true"
      ## Middlewares
      - "traefik.http.routers.prometheus-secure.middlewares=chain-oauth@file"
      ## Services
      - "traefik.http.routers.prometheus-secure.service=prometheus-svc"
      - "traefik.http.services.prometheus-svc.loadbalancer.server.port=9090"
      
  cadvisor:
    image: google/cadvisor:latest
    container_name: cadvisor
    restart: always
    #ports:
     #-8316:8080
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    depends_on:
      - redis
    devices:
      # Add all devices producing error logs from docker-compose logs cadvisor.
      - /dev/kmsg
      - /dev/loop2
      - /dev/loop3
      # TODO
      #- /dev//mapper/sdc1
    #privileged: true
    networks:
      - t2_proxy
    labels:
      - "traefik.enable=true" 
      ## Routers
      - "traefik.http.routers.cadvisor-secure.rule=Host(`cadvisor.${DOMAINNAME}`)"
      - "traefik.http.routers.cadvisor-secure.entryPoints=websecure"
      - "traefik.http.routers.cadvisor-secure.tls=true"
      ## Middlewares
      - "traefik.http.routers.cadvisor-secure.middlewares=chain-oauth@file"
      ## Services
      - "traefik.http.routers.cadvisor-secure.service=cadvisor-svc"
      - "traefik.http.services.cadvisor-svc.loadbalancer.server.port=8080"

  redis:
    image: redis:latest
    container_name: redis
    restart: always
    ports:
      - 6379:6379

volumes:
  letsencrypt:
    # Intentionally blank. Traefik will add an acme.json certificate inside this volume.
    # We are not using a file in the shared vagrant directory because all files in the vagrant share have 777 permissions and letsencrypt/Traefik require 600.

networks:
  # Traefik 2 proxy.
  t2_proxy:
    name: t2_proxy
    ipam:
      config:
       - subnet: 192.168.90.0/24
       # gateway is only honored for v2 (for now): https://github.com/docker/compose/issues/6569 and https://docs.docker.com/compose/compose-file/#ipam
       #gateway: 192.168.90.1
  # Docker socket proxy.
  # https://www.smarthomebeginner.com/traefik-docker-security-best-practices/#9_Use_a_Docker_Socket_Proxy
  socket_proxy:
    name: socket_proxy
    ipam:
      config:
       - subnet: 192.168.91.0/24
       # gateway is only honored for v2 (for now): https://github.com/docker/compose/issues/6569 and https://docs.docker.com/compose/compose-file/#ipam
       #gateway: 192.168.91.1
